# Config
#
# Scheduler configuration for ML job orchestration and coordination.
#
# The scheduler discovers worker nodes and orchestrates distributed ML training jobs.
# It should be deployed with sufficient resources for coordination overhead.
#
# Fields:
# - cert_pem: Path to the TLS certificate PEM file.
#
#     Must be a valid X.509 certificate in PEM format that establishes this scheduler's
#     identity in the P2P network. The certificate must match the private key and be
#     trusted by all peers.
#
#     SECURITY: Use certificates from a recognized CA or internal PKI for production deployments.
# - key_pem: Path to the private key PEM file.
#
#     Must correspond to cert_pem. This is the scheduler's cryptographic identity.
#
#     SECURITY:
#     * Restrict file permissions (chmod 600 recommended)
#     * Never commit to version control
#     * Store securely using secrets management systems in production
#     * Keep backups in secure, encrypted storage
# - trust_pem: Path to the trust chain PEM file (CA bundle).
#
#     Contains root and intermediate certificates trusted by this scheduler. Peers presenting
#     certificates signed by these CAs will be accepted for network connections.
# - crls_pem: Path to certificate revocation list PEM (optional).
#
#     Specifies certificates that should no longer be trusted, even if they're in the trust
#     chain. Used for compromised certificates or decommissioned peers.
#
#     SECURITY: Keep this updated with your certificate authority's latest CRL to maintain
#     network security. Automate CRL updates in production environments.
# - gateway_addresses: Gateway addresses to connect to (required for network entry).
#
#     Specifies one or more gateways for network bootstrapping and relay functionality.
#
#     Multiple gateways provide redundancy; the scheduler attempts to connect to all
#     and succeeds if any are reachable.
#
#     Examples:
#     * "/ip4/203.0.113.10/tcp/8080/"
#     * "/dns4/gateway.hypha.example/tcp/443/"
# - listen_addresses: Network addresses to listen on for incoming connections.
#
#     Supports TCP and QUIC protocols. Use port 0 to let the OS assign available ports.
#
#     Examples:
#     * "/ip4/0.0.0.0/tcp/0" - TCP on all interfaces, OS-assigned port
#     * "/ip4/0.0.0.0/udp/0/quic-v1" - QUIC on all interfaces, OS-assigned port
# - external_addresses: External addresses to advertise for peer discovery (optional).
#
#     Only advertise addresses that workers can reliably reach. Most schedulers rely on
#     relay circuits and don't need external addresses.
#
#     Examples:
#     * "/ip4/203.0.113.20/tcp/9090"
#     * "/dns4/scheduler.example.com/tcp/9090"
# - exclude_cidr: CIDR address filters for DHT routing table management.
#
#     Peer addresses matching these CIDR ranges are excluded from the Kademlia DHT before
#     being added. This prevents routing to non-routable or private addresses.
#
#     Defaults to reserved/private ranges (loopback, RFC1918, etc.).
#
#     Add additional ranges to filter internal addresses specific to your network topology.
#
#     NOTE: This only affects DHT address filtering, not direct peer connections.
# - relay_circuit: Enable listening via relay circuit through the gateway.
#
#     When enabled (default), the scheduler establishes a listening address via the gateway's
#     relay circuit (/p2p-circuit). This allows workers to reach the scheduler even if it's
#     behind NAT or firewall.
#
#     RECOMMENDATION: Keep enabled (true) unless the scheduler has public IP and external
#     addresses configured for direct connectivity.
# - telemetry_endpoint: OpenTelemetry Protocol (OTLP) endpoint for exporting telemetry data.
#
#     Sends metrics, traces, and logs to an OpenTelemetry collector or compatible backend
#     (e.g., Jaeger, Prometheus, Grafana Cloud, ...).
#
#     If unset, telemetry export is disabled (local logging only).
# - telemetry_attributes: Resource attributes included in all telemetry data.
#
#     Key-value pairs that identify this scheduler instance in your observability platform.
#     Useful for filtering and grouping metrics across multiple schedulers.
#
#     Example Attributes:
#     * service.name: "hypha-scheduler"
#     * service.version: "0.1.0"
#     * deployment.environment: "production"
#     * host.name: "scheduler-01"
#     * job.type: "training"
#
#     These attributes appear in all exported metrics, traces, and logs.
# - telemetry_headers: HTTP/gRPC headers for OTLP endpoint authentication.
#
#     Used to authenticate with your telemetry backend. Common use cases:
#     * API keys: {"Authorization": "Bearer YOUR_API_KEY"}
#     * Custom headers: {"X-API-Key": "secret"}
#
#     SECURITY: Protect these credentials. Use environment variables or secrets management
#     instead of hardcoding in config files. Never commit credentials to version control.
# - telemetry_protocol: Protocol for OTLP telemetry endpoint communication.
#
#     Choose based on your collector's supported protocols.
# - telemetry_sampler: Trace sampling strategy to control volume and costs.
#
#     Options:
#     * "always_on" - Sample every trace (high volume, expensive)
#     * "always_off" - Disable tracing (metrics and logs only)
#     * "traceidratio" - Sample traces by probability (cost-effective)
#     * "parentbased_traceidratio" - Honor parent trace decisions with fallback ratio
#
#     RECOMMENDATION: Use "traceidratio" with sample_ratio for production to balance
#     observability with costs. Start with 0.1 (10%) and adjust based on job volume.
# - telemetry_sample_ratio: Sampling probability for ratio-based trace samplers.
#
#     Valid range: 0.0 to 1.0
#     * 1.0 = 100% sampling (sample every trace)
#     * 0.1 = 10% sampling (sample 1 in 10 traces)
#     * 0.01 = 1% sampling (sample 1 in 100 traces)
#
#     Only applies to "traceidratio" and "parentbased_traceidratio" samplers.
#
#     NOTE: Lower ratios reduce telemetry costs while maintaining statistical
#     significance. For high-volume schedulers, 0.01-0.1 is probably sufficient.
# - status_bridge: AIM relay server address for real-time training metrics (optional).
#
#     Connects to an AIM server to stream training metrics in real-time. Useful for
#     monitoring job progress and visualizing training curves.
#
#     Example: "0.0.0.0:61000"
# - scheduler: Scheduler-specific configuration for job orchestration.
#
#     Contains settings for resource allocation, job scheduling policies, and worker
#     management strategies.

cert_pem = "certs/scheduler-cert.pem"
key_pem = "certs/scheduler-key.pem"
trust_pem = "certs/scheduler-trust.pem"
gateway_addresses = ["/ip4/127.0.0.1/udp/8080/quic-v1"]
listen_addresses = [
    "/ip4/127.0.0.1/tcp/0",
    "/ip4/127.0.0.1/udp/0/quic-v1",
]
external_addresses = []
exclude_cidr = ["192.0.2.0/24"]
relay_circuit = true

# telemetry_attributes = "service.name=scheduler,service.namespace=worker-pool,deployment.environment=orlando"
# telemetry_endpoint = "https://otlp-gateway-prod-eu-west-2.grafana.net/otlp"
# telemetry_headers = "Authorization=Basic%20MTM4Mzg3NTpnbGNfZXlKdklqb2lNVFUwTVRFNE1TSXNJbTRpT2lKb2VYQm9ZUzFzYjJOaGJDSXNJbXNpT2lKbk5tTXpOek14TjFOM1QwZ3lVRVJaUmpRMmVqVm9hblVpTENKdElqcDdJbklpT2lKd2NtOWtMV1YxTFhkbGMzUXRNaUo5ZlE9PQ=="
# telemetry_protocol = "http/protobuf"
# telemetry_endpoint = "https://otlp-gateway-prod-eu-west-2.grafana.net/otlp"
# telemetry_headers = "Authorization=Basic Z2xjX2V5SnZJam9pTVRBek1UQTVPU0lzSW00aU9pSm9lWEJvWVMxMGNtRnBibWx1WnlJc0ltc2lPaUkxVkROeE5FRjFNSFZYTW5neWVXUnFUemd5YWs0eE1FWWlMQ0p0SWpwN0luSWlPaUp3Y205a0xXVjFMWGRsYzNRdE1pSjlmUT09OjgzMjk2MQ=="
# telemetry_protocol = "http/protobuf"
telemetry_sampler = "parentbased_traceidratio"
telemetry_sample_ratio = 0.02

[scheduler.job]
type = "diloco"

[scheduler.job.model]
repository = "hypha-space/lenet"
filenames = [
    "config.json",
    "model.safetensors",
    "configuration_lenet.py",
    "modeling_lenet.py",
]
type = "image-classification"
input_names = [
    "pixel_values",
    "labels",
]

[scheduler.job.preprocessor]
repository = "hypha-space/lenet"
filenames = [
    "preprocessor_config.json",
    "preprocessor_lenet.py",
]
type = "image"
input_names = ["images"]

[scheduler.job.dataset]
dataset = "mnist"

[scheduler.job.rounds]
avg_samples_between_updates = 1200
update_rounds = 600
max_batch_size = 600
multi_batch_size = 3

[[scheduler.job.metrics]]
type = "otel"

[scheduler.job.inner_optimizer]
learning-rate = 0.001

[scheduler.job.outer_optimizer]
learning-rate = 0.7
momentum = 0.9

[scheduler.job.resources.worker]
gpu = 0.11
cpu = 1.0
storage = 0.0
memory = 1.0

[scheduler.job.resources.parameter_server]
gpu = 0.0
cpu = 1.0
storage = 0.0
memory = 1.0

[scheduler.job.resources.worker_price]
bid = 100.0
max = 100.0

[scheduler.job.resources.parameter_server_price]
bid = 100.0
max = 100.0

[scheduler.job.resources.worker_pool]
min = 2
target = 4
grace_ms = 90000

[scheduler.job.resources.parameter_server_pool]
min = 1
target = 2
grace_ms = 90000

[network]
bandwidth_mbps = 1000
rtt_ms = 150
handshake_timeout = 30
